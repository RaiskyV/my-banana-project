<!-- ... (весь HTML-код до скрипта остаётся без изменений) ... -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- THEME ---
      const htmlEl = document.documentElement;
      const themeToggle = document.getElementById('theme-toggle');
      function showToast(msg) { 
        const toast = document.getElementById('toast');
        toast.textContent = msg; 
        toast.classList.remove('hidden'); 
        setTimeout(() => toast.classList.add('hidden'), 2200); 
      }
      function setThemeFromStorage() { 
        const theme = localStorage.getItem('theme');
        if (theme === 'light') {
          htmlEl.classList.remove('dark');
          htmlEl.classList.add('light');
        } else {
          htmlEl.classList.add('dark');
          htmlEl.classList.remove('light');
        }
      }
      setThemeFromStorage();
      themeToggle.addEventListener('click', () => { 
        htmlEl.classList.toggle('dark'); 
        htmlEl.classList.toggle('light'); 
        localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light'); 
      });

      // --- ELEMENTS ---
      const imageUploadInput = document.getElementById('image-upload-input');
      const addImageLabel = document.getElementById('add-image-label');
      const previewsContainer = document.getElementById('image-previews-container');
      const promptInput = document.getElementById('prompt-input');
      const translateBtn = document.getElementById('translate-btn');
      const improvePromptBtn = document.getElementById('improve-prompt-btn');
      const generateBtn = document.getElementById('generate-btn');
      
      const outputPlaceholder = document.getElementById('output-placeholder');
      const outputLoader = document.getElementById('output-loader');
      const outputImage = document.getElementById('output-image');
      const outputActions = document.getElementById('output-actions');
      const viewImageBtn = document.getElementById('view-image-btn');
      const downloadImageBtn = document.getElementById('download-image-btn');
      const outputError = document.getElementById('output-error');

      const imageViewerModal = document.getElementById('image-viewer-modal');
      const modalImage = document.getElementById('modal-image');
      const modalCloseBtn = document.getElementById('modal-close-btn');

      const geminiModal = document.getElementById('gemini-modal');
      const geminiModalOverlay = document.getElementById('gemini-modal-overlay');
      const geminiModalTitle = document.getElementById('gemini-modal-title');
      const geminiModalContent = document.getElementById('gemini-modal-content');
      const geminiModalCloseBtn = document.getElementById('gemini-modal-close-btn');

      let uploadedFiles = [];
      const MAX_FILES = 5;

      // --- API KEYS ---
      const GEMINI_API_KEY = "AIzaSyAfxN5kHgrXQC0EH6gd3A8-TG-3edlz9BI";
      // REPLICATE_API_TOKEN is now on the server

      // --- TEXTAREA AUTOSIZE ---
      function autosizeTextarea(el) {
          el.style.height = 'auto';
          el.style.height = (el.scrollHeight) + 'px';
      }
      promptInput.addEventListener('input', () => autosizeTextarea(promptInput));

      // --- IMAGE UPLOAD LOGIC ---
      addImageLabel.addEventListener('click', (e) => {
        if (uploadedFiles.length >= MAX_FILES) {
          e.preventDefault();
          showToast(`Можно загрузить не более ${MAX_FILES} изображений.`);
        }
      });
      imageUploadInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const remainingSlots = MAX_FILES - uploadedFiles.length;
        const filesToProcess = files.slice(0, remainingSlots);
        filesToProcess.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const fileData = { id: Date.now() + Math.random(), file: file, dataUrl: event.target.result };
            uploadedFiles.push(fileData);
            renderPreviews();
          };
          reader.readAsDataURL(file);
        });
        imageUploadInput.value = '';
      });

      function renderPreviews() {
        previewsContainer.innerHTML = ''; 
        uploadedFiles.forEach(fileData => {
          const previewElement = document.createElement('div');
          previewElement.className = 'preview-element relative w-16 h-16 rounded-lg overflow-hidden group flex-shrink-0';
          previewElement.innerHTML = `
            <img src="${fileData.dataUrl}" class="w-full h-full object-cover">
            <button data-id="${fileData.id}" class="remove-btn absolute top-0.5 right-0.5 p-0.5 bg-black/60 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
              <iconify-icon icon="lucide:x" width="12" height="12"></iconify-icon>
            </button>
          `;
          previewsContainer.appendChild(previewElement);
        });
        previewsContainer.appendChild(addImageLabel);
        addImageLabel.style.display = uploadedFiles.length < MAX_FILES ? 'flex' : 'none';
        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const idToRemove = parseFloat(e.currentTarget.dataset.id);
                uploadedFiles = uploadedFiles.filter(f => f.id !== idToRemove);
                renderPreviews();
            });
        });
      }
      renderPreviews();
      
      // --- GEMINI & TRANSLATE LOGIC ---
      async function callGemini(prompt) {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          const result = await response.json();
          return result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || "";
      }
      translateBtn.addEventListener('click', async () => {
        const text = promptInput.value.trim();
        if (!text) { showToast('Введите текст для перевода.'); return; }
        translateBtn.disabled = true;
        const originalIcon = translateBtn.innerHTML;
        translateBtn.innerHTML = `<iconify-icon icon="line-md:loading-loop" width="20" height="20"></iconify-icon>`;
        const prompt = `Translate the following Russian text to English. Return ONLY the translated text... Text to translate: "${text}"`;
        try {
            const translatedText = await callGemini(prompt);
            promptInput.value = translatedText;
            autosizeTextarea(promptInput);
        } catch (error) {
            console.error("Translate Error:", error);
            showToast('Ошибка перевода.');
        } finally {
            translateBtn.disabled = false;
            translateBtn.innerHTML = originalIcon;
        }
      });
      improvePromptBtn.addEventListener('click', async () => {
        const text = promptInput.value.trim();
        if (!text) { showToast('Введите промпт, чтобы его улучшить.'); return; }
        showGeminiModal('Улучшение промпта', '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>');
        const prompt = `You are an expert prompt engineer... User's prompt: '${text}'`;
        try {
          const improvedPrompts = await callGemini(prompt);
          showGeminiModal('Варианты улучшений', markdownToHtml(improvedPrompts));
        } catch (error) {
          console.error("Gemini API Error:", error);
          showGeminiModal('Ошибка', `<p class="text-red-400">Ошибка: ${error.message}</p>`);
        }
      });

      // --- GENERATE LOGIC (UPDATED FOR CUSTOM DOMAIN) ---
      generateBtn.addEventListener('click', async () => {
        const prompt = promptInput.value.trim();
        if (uploadedFiles.length === 0) { showToast('Добавьте хотя бы один референс.'); return; }
        if (!prompt) { showToast('Введите промпт.'); return; }

        generateBtn.disabled = true;
        document.getElementById('generate-text').textContent = 'Generating...';
        document.getElementById('generate-icon').classList.add('hidden');
        document.getElementById('generate-loader').classList.remove('hidden');
        
        outputPlaceholder.classList.add('hidden');
        outputImage.classList.add('hidden');
        outputError.classList.add('hidden');
        outputLoader.classList.remove('hidden');

        try {
            const imageDataUrls = uploadedFiles.map(f => f.dataUrl);
            // *** ИЗМЕНЕНИЕ: Указываем полный URL вашего API на Vercel ***
            const response = await fetch('https://my-banana-project.vercel.app/api/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    images: imageDataUrls,
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Ошибка сервера: ${response.status}`);
            }

            const result = await response.json();
            const resultUrl = result.output_url;
            
            outputImage.src = resultUrl;
            downloadImageBtn.href = resultUrl;
            outputImage.onload = () => {
                outputLoader.classList.add('hidden');
                outputImage.classList.remove('hidden');
                outputImage.classList.add('fade-in');
                setTimeout(() => {
                    outputActions.classList.remove('opacity-0', 'pointer-events-none');
                }, 100);
            };
        } catch (error) {
            console.error('Generation failed:', error);
            outputError.textContent = `Ошибка: ${error.message}`;
            outputError.classList.remove('hidden');
            outputLoader.classList.add('hidden');
        } finally {
            generateBtn.disabled = false;
            document.getElementById('generate-text').textContent = 'Generate';
            document.getElementById('generate-icon').classList.remove('hidden');
            document.getElementById('generate-loader').classList.add('hidden');
        }
      });
      
      // --- MODAL LOGIC (Image Viewer & Gemini) ---
      function showGeminiModal(title, content) { /* ... (no changes) ... */ }
      function closeGeminiModal() { /* ... (no changes) ... */ }
      geminiModalCloseBtn.addEventListener('click', closeGeminiModal);
      geminiModalOverlay.addEventListener('click', closeGeminiModal);
      function markdownToHtml(text) { /* ... (no changes) ... */ }
      function openImageViewer(src) { /* ... (no changes) ... */ }
      function closeImageViewer() { /* ... (no changes) ... */ }
      viewImageBtn.addEventListener('click', () => openImageViewer(outputImage.src));
      modalCloseBtn.addEventListener('click', closeImageViewer);
      imageViewerModal.addEventListener('click', (e) => {
        if (e.target === imageViewerModal) closeImageViewer();
      });
    });
  </script>
</body>
</html>

